---
title: "Suplementary Material. Rutine, analysis and outpus extra"
subtitle: "Pygoscelis penguin breeding success along the Western Antarctic Peninsula under contrasting krill biomass and fixed catch limit"
author:
  - Krüger, Lucas^[Instituto Antártico Chileno, Milenio BASE]
  - Santa-Cruz, Francisco^[Instituto Antártico Chileno]
  - Mardones, Mauricio^[Instituo de Fomento Pesquero]
  - Cárdenas, César^[Instituto Antártico Chileno, Milenio BASE]
date:  "`r format(Sys.time(), '%d %B, %Y')`"
format:
  pdf:
    theme: cosmo
    toc: true
    toc-depth: 4
bibliography: breeding.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
---

```{=tex}
\fontsize{10}{12}
\selectfont
```

\pagebreak 

# BACKGROUND

This selfcontained document content the codes for: 

- 1. evaluate temporal trends of Pygoscelis penguin breeding success in the South Shetland Islands and Antarctic Peninsula; 

- 2.  evaluate temporal variability of krill biomass in relation to fishing harvest; 

- 3. compare penguin breeding success in periods of low or high krill biomass and low or high fishing catches. 


```{r setup1}
### Set format conditions
rm(list = ls())
dir.fig        <-"fig/"
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.path = dir.fig,
                      fig.align = 'center',
                      fig.pos = "H",
                      dev = 'jpeg',
                      dpi = 300,
                      fig_width = 8,
                      fig.height = 5,
                      tidy.opts=list(width.cutoff=40),
                      tidy=TRUE)
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
dir.fig        <-"fig/"
```


```{r library}
### Load necessary packages
library(plyr)
library(dplyr) # for summarizing data
library(reshape2)
library(ggplot2)  # plotting 
library(sjPlot)
library(patchwork)
library(lubridate) # to deal with time data
library(udunits2) # to deal with geographical data
library(raster)
library(MCMCglmm) #Bayesian generalized linear mixed models
library(lmerTest)
library(rcompanion)
library(lmPerm)
library(ggsignif)
library(energy)
library(kableExtra)
library(ggthemes)
library(ggpubr)
library(fitdistrplus)
library(AER)
library(easystats)
library(formatR)
```
\pagebreak
# DATA

Four data sources were used: 

- [MAPPPD data](Humphries et al. 2017 https://doi.org/10.1017/S0032247417000055) [@Humphries2017], file named `MAPPPD.Rds` 

- CCAMLR acoustic estimates of krill biomass `CCAMLR_krill_biomass.Rds`, 

- Summarized fishing catch `CCAMLR_krill_fishing_catch.Rds`

- Management strata shapefiles `AMLR_Strata.Rds`. 

Refer to the manuscript for methodological details.

\pagebreak
# ANALISYS ROUTINE

Query for area 48.1

```{r,echo=TRUE}
peng<-readRDS("MAPPPD.Rds") 
nests<-subset(peng,
              count_type=="nests",
              select=c(site_name,
                       site_id,
                       longitude_epsg_4326,
                       latitude_epsg_4326,
                       common_name,
                      day,
                      month,
                      season_starting,
                      penguin_count,
                       count_type,
                      vantage,accuracy))
```


```{r,echo=TRUE}
chicks<-subset(peng,count_type=="chicks",
               select=c(site_name,
                        site_id,longitude_epsg_4326,
                        latitude_epsg_4326,
                    common_name,
                    day,month,season_starting,penguin_count,
                        count_type,vantage,accuracy))
nestsM<-ddply(nests, c("common_name",
                       "site_name",
                       "site_id",
                       "season_starting"), 
              summarise,
              nests=max(penguin_count),
              Lat=mean(latitude_epsg_4326),
              Long=mean(longitude_epsg_4326))

chicksM<-ddply(chicks, c("common_name",
                         "site_name",
                         "site_id",
                         "season_starting"),
               summarise,
               chicks=min(penguin_count),
               Lat=mean(latitude_epsg_4326),
               Long=mean(longitude_epsg_4326))

cpn<-merge(nestsM,chicksM)
```

Measure of breeding success (chicks raised per nest)

```{r,echo=TRUE}
cpn$chickspernest<-cpn$chicks/cpn$nests  

cpn2<-data.frame(site=cpn$site_id,SP=cpn$common_name,
                 Year=cpn$season_starting,
                 Long=as.numeric(cpn$Long),
                 Lat=as.numeric(cpn$Lat),
                 chickspernest=cpn$chickspernest) # cpn stands for Chicks Per Nest
```

this is for summarizing number of populations and number of counts



```{r,echo=TRUE}
cpnset<-cpn2 

counts<-ddply(cpnset, c("SP"), summarise,
              ncounts=length(chickspernest))

                                  
kbl(counts, 
    longtable = F, 
    booktabs = T, 
    caption = "\\label{Table1}Count colonies") %>% 
  kable_styling(latex_options = c("striped",  "hold_position"))
```

Data wranling
```{r,echo=TRUE}
pops<-ddply(cpn2, c("SP","site"), summarise,
            pops=length(chickspernest),
            Lat=mean(Lat),Long=mean(Long))
pops2<-ddply(pops, c("SP"), summarise,
             Npops=length(pops))
sites<-ddply(cpn, c("site_id"), summarise,
             Ncounts=length(chicks))
cpn$chickspernest<-cpn$chicks/cpn$nests  ### measure of breeding success (chicks raised per nest)
cpn<-merge(cpn,sites,by="site_id")
summary(cpn$nests)
```

some plot about variable behavior.

```{r echo=TRUE, message=FALSE, warning=FALSE}
a <- ggplot(cpn,aes(nests))+
  geom_histogram()+
  xlim(0,10000)+
  theme_few()
b <- ggplot(cpn,aes(nests))+
  geom_histogram()+
  xlim(0,100)+ # check small populations
  theme_few()
c <- ggplot(cpn,aes(nests,chickspernest))+
  geom_point()+
  theme_few()# a single large population will be excluded too

ggarrange(a,b,c, ncol=2)
```


eliminate pops with success = 2, as they were two cases of one or two nests
eliminate the single population with 80 000 nests
```{r }
cpn<-subset(cpn,chickspernest<2 & nests<40000) # assuming any estimation of success above 2 would mean imprecise counts

summary(cpn$chickspernest)

cpn<-subset(cpn,Ncounts>3) # only colonies with more than 3 counts

shapiro.test(cpn$chickspernest) # not normal
```

the plot shows us that there was site-level slope variability and there was few sites with data previous to 1990. So, further filters:

```{r }
ggplot(cpn,aes(season_starting,chickspernest))+
  geom_point()+
  geom_vline(xintercept = 1990)+
  geom_smooth(method="lm",se=F)+
  facet_wrap(site_id~.)+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90, hjust = 2),
        panel.grid = element_blank())+
  labs(
    x="",
    y="Chicks raised per nest"
  )
  

```
correlation analysis

```{r}
results <- correlation(cpn)
results %>%
  summary(redundant = TRUE) %>%
  plot()
```
Positive correlation between chicks and nest.


Testing normality

```{r }
cpn<-subset(cpn,season_starting>1989)

cpn<-subset(cpn,site_id!="SELV" & site_id!="SPTR") 

shapiro.test(cpn$chickspernest) # not normal 
shapiro.test(cpn$chickspernest[cpn$chickspernest>0.5]) # normal if eliminate values lower than 0.5
```


```{r }
cpn<-subset(cpn, chickspernest>0.5)

 ggplot(cpn,aes(chickspernest))+
   geom_histogram(bins = 50,
                  col="white")+
   geom_density(col=2,
                adjust = 1,
                position = "stack")+
   theme_few()+
   xlab("Chicks raised per nest")
```
Kind of distribution with `descdist` function. Computes descriptive parameters of an empirical distribution for non-censored data and provides a skewness-kurtosis plot [@Delignette-Muller2015]

```{r}
dist <- descdist(cpn$chickspernest, boot = 200)
```
Normal distribution

\pagebreak
# MODELLING

test if chicks per nest varied in time using sites  as random factors

```{r }
### 

cpn$Zss<-scale(cpn$season_starting,center=T) # scaling the time variable


cpn$site_id2<-factor(cpn$site_id,levels=c("LLAN","ARDL","BART","SHIR","HALF","ENTR",
                                          "BROW","SPIP","ORNE","GEOR","LITC","DOBE","DAMO","LOCK",
                                          "JOUG","NEKO","ALMI","PCHA","PLEN","PETE"))  # order by location latitude

cpn$site_name2<-factor(cpn$site_name,
                       levels=c("Llano Point","Ardley Island",
                                "Barton Peninsula",
                                "Cape Shirreff","Half Moon Island",
                                "Entrance Point",
                                "Brown Bluff","Spigot Peak Point",
                                "Orne Islands",
                                              "Georges Point (Ronge Island)","Litchfield Island",
                                              "Dorian Beacon","Dorian Bay/Damoy Point","Port Lockroy",
                                              "Jougla Point","Neko Harbor (Andvord Bay)",
                                              "Brown Station","Port Charcot",
                                              "Pleneau Island","Petermann Island"))  # order by location latitude

#species summaries 

length(unique(cpn$site_id[cpn$common_name=="adelie penguin"]))
length((cpn$site_id[cpn$common_name=="adelie penguin"]))
length(unique(cpn$site_id[cpn$common_name=="chinstrap penguin"]))
length((cpn$site_id[cpn$common_name=="chinstrap penguin"]))
length(unique(cpn$site_id[cpn$common_name=="gentoo penguin"]))
length((cpn$site_id[cpn$common_name=="gentoo penguin"]))
```


```{r }
ggplot(cpn,aes(season_starting,chickspernest))+
  geom_point(size=1,alpha=0.5)+
  geom_smooth(method="lm",se=F)+
  facet_wrap(site_name2~.)+
  theme_bw()+
  theme(panel.spacing.x = unit(1.5, "lines"))
```

Maximum likelihood or restricted maximum likelihood (REML) estimates of the parameters in linear mixed-effects models can be determined using the lmer function in the lme4 package for R. 

As for most model-fitting functions in R, the model is described in an lmer call by a formula, in this case including both fixed- and random-effects terms. The formula and data together determine a numerical representation of the model from which the profiled deviance or the profiled REML criterion can be evaluated as a function
of some of the model parameters [@Bates2015]. 

```{r }
lmer1<-lmer(chickspernest~Zss+(Zss|site_id),data=cpn)  #previous picture justified the structure of the random term (there was site-level slope variability)
check_model(lmer1)
```

Not enough model terms in the conditional part of the model to check  for multicollinearity.
Some of the variables were in matrix-format - probably you used   `scale()` on your data?

If so, and you get an error, please try `datawizard::standardize()`  to standardize your data.

```{r }
isSingular(lmer1)# 
```

convergence problems detected, therefore, a Bayesian evaluation with flexible priors is justified to avoid convergence issues 
```{r }
prior<- list(R = list(V = 1, nu = 0.002),
             G = list(G1 = list(V = diag(2),
                                nu = 0.002,
                                alpha.mu = rep(0, 2),
                                alpha.V= diag(2, 2, 2))))
```


```{r }
mc1<-MCMCglmm(chickspernest~season_starting,
              random=~us(1 + Zss):site_id, rcov=~units,
              family="gaussian",
              data=cpn, nodes="ALL",  
              scale=TRUE, nitt=10999, thin=1, burnin=1000, pr=T,
              pl=FALSE, verbose=TRUE, DIC=TRUE, singular.ok=FALSE, 
              saveX=TRUE,
              saveZ=TRUE, saveXL=TRUE, slice=FALSE, 
              ginverse=NULL, trunc=FALSE,
              prior= prior)
```



```{r }
summary(mc1) # no significance
```


```{r}
par(mar = c(1, 1, 1, 1))
plot(mc1$Sol) 
plot(mc1$VCV) # 
```
Diagnostic plots for site effects majority of posteriors distributions were acceptable and diagnostic plots for random effects were acceptable.

Proportion of the effective sample size: we want a low number as it indicates model converged with less iterations

```{r }
summary(mc1)$solutions[2,4]/10999 
sol<-data.frame(mc1$Sol) # random effects
solm<-melt(sol,id.vars=c("X.Intercept.","season_starting"))
solm$vars<-substring(solm$variable,first=1,last=4)
slm<-subset(solm,vars=="Zss.") #select slopes
tail(slm)
slm$site_id<-substring(slm$variable,first=13,last=17)
sites<-ddply(cpn, c("site_id"), summarise,
             pops=length(chickspernest),
             Lat=mean(Lat),Long=mean(Long))
ranef<-ddply(slm, c("site_id"), summarise,
             slp=mean(season_starting),slpsd=sd(season_starting),
             slpse=slpsd/sqrt(length(value)-1),
             med=median(value),
             q95=quantile(value,prob=0.95),
             q05=quantile(value,prob=0.05))
rlat<-merge(slm,sites,by="site_id")
ranef<-ddply(slm, c("site_id"), summarise,
             slp=mean(value),slpsd=sd(value),
             slpse=slpsd/sqrt(length(value)-1),
             med=median(value),
             q95=quantile(value,prob=0.95),
             q05=quantile(value,prob=0.05))
rlat<-merge(ranef,sites,by="site_id")
rlat$Lat_ID<-paste(rlat$Lat,rlat$site_id)
rlat$local<-ifelse(rlat$Lat<(-63.2),"Peninsula","South Shetlands")
pairwisePermutationTest(slp~local,data=rlat) # 
```

difference is marginally significant

Plot with random effects
```{r}
ggplot(rlat,aes(local,slp))+
  geom_boxplot()+
  theme_bw()+
  xlab("")+ylab("Random slope")+
  coord_flip()+
    geom_signif(comparisons = list(c("Peninsula","South Shetlands")),
      map_signif_level = F,
      step_increase = 0.075,
      test="wilcox.test", # 
      textsize = 3)
```

could not change the Wilcox test for the permutation results, but this is just for plotting

### Load krill acoustic data 

from "WG-ASAM Results from the WG-ASAM Intersessional e-Group on Krill Biomass Estimates from Acoustic Surveys; 2021;"

data from WG-ASAM e-group (2021) and subset the strata where fishing has been consistent
```{r,echo=TRUE}
krill<-readRDS("CCAMLR_krill_biomass.Rds")  
krill2<-subset(krill,
               Strata=="Bransfield"|Strata=="West") 
```

### Load fihery data 

Fishing data from CCAMLR, this is the raw data, not available freely (only the CCAMLR secretariat is allowed to distribute it) 

```{r,echo=TRUE}
kf0<-read.csv("C1_Sect.csv") 
kf0$CatchT<-kf0$KrillCaughtKG/1000  ### catch in tones
kf0$ts<- as.POSIXct(strptime(kf0$Day,format="%m/%d/%Y" ,tz="GMT")) 
kf0$month<-month(kf0$ts)
kf0$FSeason<-ifelse(kf0$month>11,
            kf0$CalendarYear,kf0$CalendarYear-1)
kf<-kf0
```

Fishing season starts in december - january up to november next year is assigned to the season of the previous year krill season however, places december to the following year, therefore fishing season 2018=krill season 2019.

from CCAMLR as well `AMLR_strata.Rds`
```{r,echo=TRUE}
strata<-readRDS("AMLR_STRATA.Rds")  
crs=CRS( "+proj=longlat +datum=WGS84 +no_defs")
kcoords<-coordinates(data.frame(x=kf$FishingLon,y=kf$FishingLat))
kf.spdf<-SpatialPointsDataFrame(kcoords,kf,proj4string = crs)
kf.strata<-over(kf.spdf,strata)
kf.spdf$Strata<-kf.strata$Strata
kf.spdf<-subset(kf.spdf,FishingLon<(-50))  # eliminate the South Orkney Data 
```

bring krill and fishery together 

```{r,echo=TRUE}
kf.spdf$Year<-kf.spdf$CalendarYear
```

and  months with krill estimation
```{r,echo=TRUE}
kfMo<-subset(kf.spdf,month=="12"|month=="1"|month=="2"|month=="3") 
fcr2<-ddply((data.frame(kfMo)), c("Year","Strata"), summarise,
            CatchS=sum(CatchT))  ### total catch for each year and strata
```

this is the data we made available (CCAMLR_krill_fishing_catch.Rds), already summarized fishing data
```{r echo=TRUE}
summary(fcr2) ### CatchS is catch in Ton
kr<-data.frame(krill[1],krill[2],krill[14]) # keep only needed variables
kmfcr<-merge(kr,fcr2,by=c("Strata","Year"),all=T)  # merge krill and fishery data 
kmfcr2<-subset(kmfcr,Year<2019 & Year>1994)
```

check 1st quantiles to fill missing values
```{r echo=TRUE}
summary(kmfcr2$amlrbiomass[kmfcr2$Strata=="Bransfield"]) 
summary(kmfcr2$amlrbiomass[kmfcr2$Strata=="West"])
kmfcr2$amlrbiomass[is.na(kmfcr2$amlrbiomass) & kmfcr2$Strata=="Bransfield"]<-392888# 1st qu
kmfcr2$amlrbiomass[is.na(kmfcr2$amlrbiomass) & kmfcr2$Strata=="West"]<-752566# 1st qu
```

substitute missing values by 0 (no catch)
```{r echo=TRUE}
summary(kmfcr2$CatchS[kmfcr2$Strata=="West"])
summary(kmfcr2$CatchS[kmfcr2$Strata=="Bransfield"])
kmfcr2$CatchS[is.na(kmfcr2$CatchS) & kmfcr2$Strata=="West"]<-0 # 1st qu
kmfcr2$CatchS[is.na(kmfcr2$CatchS) &  kmfcr2$Strata=="Bransfield"]<-0 # 1st qu
kmfcr2$Strata<-factor(kmfcr2$Strata,levels=c("West","Bransfield"))
summary(kmfcr2$amlrbiomass/1000)
```

Harvest rate
```{r echo=TRUE}
kmfcr2$CatchK<-kmfcr2$CatchS/kmfcr2$amlrbiomass # harvest rate 
kmfcr2$State[(kmfcr2$amlrbiomass/1000)<1251.728 & kmfcr2$Strata=="West"]<-"Biomass < mean"
kmfcr2$State[(kmfcr2$amlrbiomass/1000)<802.284 & kmfcr2$Strata=="Bransfield"]<-"Biomass < mean"
kmfcr2$State[(kmfcr2$amlrbiomass/1000)<200]<-"Near or below catch limit"
kmfcr2$State[is.na(kmfcr2$State)]<-"Biomass > mean"
```

Plot 

```{r echo=TRUE}
plot2a<-ggplot()+
  geom_hline(yintercept=155,linetype="dotted",colour="red")+
  geom_hline(yintercept=1251.728,linetype="dashed")+
  geom_hline(yintercept=802.284,linetype="dashed")+
  geom_smooth(data=subset(kmfcr2,Strata=="Bransfield"|Strata=="West"),
              aes(x=Year,y=(amlrbiomass/1000)),
              method="lm",se=F,
              fullrange=F,
              formula=y~x)+
  xlim(1995,2018)+
  geom_point(data=subset(kmfcr2,
                         Strata=="Bransfield"|Strata=="West"),
             aes(x=Year,y=(amlrbiomass/1000),
                 colour=State),size=2)+
  theme_bw()+
  facet_wrap(~Strata)+
  ggtitle(label="a. krill biomass")+
  scale_colour_manual(values=c("yellow3","green2","red2"))+
  ylab("thousand tonnes")+xlab("") # figure X


plot2b<-ggplot()+
  geom_hline(yintercept=5,linetype="dotted",colour="red")+geom_point()+
  
  geom_smooth(data=subset(kmfcr2,Strata=="Bransfield"|Strata=="West"),
              aes(x=Year,y=(CatchK*100)),method="lm",se=F,fullrange=F,span=0.9)+xlim(1995,2018)+
  geom_point(data=subset(kmfcr2,Strata=="Bransfield"|Strata=="West"),
             aes(x=Year,y=(CatchK*100),colour=State),size=2)+theme_bw()+facet_wrap(~Strata)+
  ggtitle(label="b. krill caught biomass")+
  scale_colour_manual(values=c("yellow3","green2","red2"))+
  ylab("% of catched biomass") # figure X


plot2c<-ggplot()+
  geom_hline(yintercept=5,linetype="dashed")+geom_point()+
  geom_vline(xintercept=1251.728,linetype="dashed")+
  geom_vline(xintercept=802.284,linetype="dashed")+
  geom_smooth(data=subset(kmfcr2,Strata=="Bransfield"|Strata=="West"),
              aes(x=(amlrbiomass/1000),
                  y=(CatchK*100)),
              method="gam",se=F,
              fullrange=F,span=0.9)+
  geom_point(data=subset(kmfcr2,
                         Strata=="Bransfield"|Strata=="West"),
             aes(x=(amlrbiomass/1000),
                 y=(CatchK*100),
                 colour=State),size=2)+
  theme_bw()+facet_wrap(~Strata)+
  ggtitle(label="c. availability vs catch")+
  scale_colour_manual(values=c("yellow3","green2","red2"))+
  ylab("% of catched biomass")+ 
  xlab("Krill biomass (million tonnes)") # figure X
```


```{r echo=TRUE, message=FALSE, fig.height=7, fig.width=6}
ggarrange(plot2a, plot2b, plot2c, ncol=1)
```

Testing whether krill biomass changed in time 

```{r,echo=TRUE}
kmfcr2<-na.omit(kmfcr2)
ggplot(kmfcr2,aes(amlrbiomass))+geom_histogram()+theme_bw()
```

Test for poisson distribution. Yes it is
```{r,echo=TRUE}
poisson.mtest(as.integer(kmfcr2$amlrbiomass),R=99) 
glm1<-glm(amlrbiomass~Year,
          data=subset(kmfcr2,
                      Strata=="West"),
          family="poisson")
glm2<-glm(amlrbiomass~Year,
          data=subset(kmfcr2,
                      Strata=="Bransfield"),
          family="poisson")
```


```{r,echo=TRUE}
check_model(glm1) 
check_model(glm2)
```
Not enough model terms in the conditional part of the model to check for
  multicollinearity.
  
Another diagnosis

```{r,echo=TRUE}
dispersiontest(glm1)
dispersiontest(glm2)
```

### Penguins and fishery join data

transfer strata information into penguin data

```{r,echo=TRUE}
pcoords<-coordinates(data.frame(cpnset[4:5])) 
p.spdf<-SpatialPointsDataFrame(pcoords,cpnset,proj4string = crs)
identicalCRS(p.spdf,strata)
p.strata<-over(p.spdf,strata)
p.spdf$Strata<-p.strata$Strata
p.spdf$StrataP<-p.spdf$Strata
```

Merge data penguins and fishery
```{r,echo=TRUE}
p.df<-data.frame(p.spdf)
peng<-data.frame(p.df[1:8]) ## maintain in the data only variables to analyze
summary(as.factor(peng$StrataP))
peng.f<-merge(peng,kmfcr2,all.x=T)  ## merge and maintain all penguin data
pengf<-subset(peng.f,StrataP==Strata)#if penguin and fishing strata coincides, then it is right
pengf$harvest<-pengf$CatchS/pengf$amlrbiomass # catch per unit of krill biomass (harvest rate)
```


```{r,echo=TRUE, fig.cap="Figura 2. Suplem"}
ggplot(pengf,aes(harvest,chickspernest))+ #figure supp2
  geom_point()+
  theme_bw()+
  xlab("% of caught biomass (harvest rate)")+
  ylab("chicks raised per nest")+
  geom_vline(xintercept=0.05,linetype="dashed") #5% catch
```


```{r,echo=TRUE}
pengf$HR<-ifelse(pengf$harvest>0.05,">5%","<5%")
pengf<-na.omit(pengf)
pengf$KrillC<-pengf$State
summary(as.factor(pengf$KrillC))
pengf$KrillC[pengf$KrillC=="Near or below catch limit"]<-"Biomass < mean"
ddply(pengf, c("HR","KrillC"), summarise,
      ncounts=length(chickspernest))
```

test distribution
```{r,echo=TRUE}
shapiro.test(pengf$chickspernest)#not normal
shapiro.test(pengf$chickspernest[pengf$chickspernest>0.5]) # normal if eliminating values below 0.5
pengf2<-subset(pengf,chickspernest>0.5)
```


```{r,echo=TRUE, warning=F, message=FALSE}
ah <- ggplot(pengf,aes(chickspernest))+
  geom_histogram()+
  theme_few()
bh <- ggplot(pengf2,aes(chickspernest))+
  geom_histogram()+
  theme_few() # visualize two distributions
ggarrange(ah , bh, ncol=2, 
          labels = c("A", "B"))
```

```{r,echo=TRUE}
summary(as.factor(pengf2$HR))
summary(as.factor(pengf2$KrillC))
unique(pengf2$site)
pengf2$HRK<-paste(pengf2$KrillC,pengf2$HR,sep=", Catch") # harvest rate and krill categories
summary(as.factor(pengf2$HRK)) 
pengf2$HRK2<-factor(pengf2$HRK,levels=c("Biomass > mean, Catch<5%",
                                        "Biomass < mean, Catch<5%",
                                        "Biomass < mean, Catch>5%"))
bartlett.test(pengf2$chickspernest,pengf2$HRK2) # homogeneity is marginal
```


```{r,echo=TRUE}
summary(as.factor(pengf2$HRK2))
```


```{r echo=TRUE}
lmer2<-lmer(chickspernest~HRK2+(harvest|site),
            data=pengf2)
anova(lmer2,
      ddf="Satterthwaite",
      type = "III")
pairwisePermutationTest(lmer2@call$formula,
                        data=pengf2,
                        teststat="quadratic",
                        method="BH",
                        distribution="approximate")
```


```{r echo=TRUE}
ranova(lmer2)
```


```{r}
plot_model(lmer2,type="diag",
           colors = "Set2")

plot_model(lmer2,
           type="re",
           grid=F)
```

another way
```{r,echo=TRUE}
pre <- plot_model(lmer2,type = "re", 
                facet.grid=TRUE, 
                free.scale = FALSE, 
                title = NULL, 
                vline.color = "darkgrey",
                sort.est = TRUE,
                colors = "Set1",
                show.data = TRUE,
                jitter = 0.2,
                terms = "Days")+
  theme_minimal()
pest <- plot_model(lmer2,type = "est", 
                facet.grid=FALSE, 
                free.scale = FALSE, 
                title = NULL, 
                vline.color = "darkgrey",
                sort.est = TRUE,
                colors = "Set2",
                show.data = TRUE,
                jitter = 0.2)+
  theme_minimal()
ggarrange(pre, pest, ncol = 2)
```


```{r,echo=TRUE}
ggplot(pengf2,aes(HRK2,chickspernest))+
    geom_hline(yintercept=1,
               linetype="dashed",
               linewidth=1)+
    geom_boxplot()+
    theme_bw()+
  xlab("")+
  ylab("Chicks raised per nest")+coord_flip()+
  geom_signif(comparisons = list(c("Biomass > mean, Catch<5%",
                                   "Biomass < mean, Catch<5%"),
                         c("Biomass < mean, Catch<5%",
                           "Biomass < mean, Catch>5%"),
                         c("Biomass > mean, Catch<5%",
                           "Biomass < mean, Catch>5%")),
      map_signif_level = F,
      step_increase = 0.075,
      test="t.test", # could not change it to the permutation results, but this is just for plotting
      textsize = 3)
```


```{r,echo=TRUE}
max(pengf2$CatchS)
```


```{r,echo=TRUE}
# next plots are just to explore a little bit more...
pengf3<-subset(pengf2,site!="AITC" & site!="HANN"& site!="PTHO")
```


```{r,echo=TRUE}
ggplot()+
  geom_point(data=pengf3,
             aes(x=CatchS,
                 y=chickspernest,
                 colour=KrillC,
                 shape=SP))+
  theme_bw()+
  theme(panel.spacing.x = unit(1.5, "lines"),
                   axis.text.x = element_text(angle=90))+
  geom_smooth(method="lm",se=F,
              data=pengf3,
              aes(x=CatchS,
                  y=chickspernest,
                  colour=KrillC))+
  scale_colour_manual(values=c("red","blue"),
                      name="Krill availability")+
  facet_wrap(site~.)+
  xlim(0,50000)+
  xlab("Accumulated summer fishing catch (t)")+ 
  ylab("Penguin chicks raised per nest")
```



Taking only sites with multiple samples in contrasting krill availabilkity: at ARDL, BART (neighbor areas) increased catch in years with low krill biomass meant decreasing breeding success;  Shireff is the only site in the Drake passage, and trends were inverted; but there was no samples in years with very hich catch...

\pagebreak

# REFERENCES